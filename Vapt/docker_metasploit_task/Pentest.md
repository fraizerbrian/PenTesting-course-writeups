# Pentest - Metasploit

---------------------------

## CHECKLIST
- [x] Information Gathering
	- [x] Network scan
	- [x] Identify web server, technologies and database
	- [x] Vulnerable versions
- [ ] Exploiting the Various ports
	- [x] Port 21
	- [x] Port 22
	- [x] Port 23
	- [x] Port 25
	- [x] Port 80
	- [x] Port 139 & 445
- [ ] OWASP TOP 10
	- [ ] Injection
	- [ ] Broken Authentication
	- [ ] Sensitive Data Exposure
	- [ ] XML External Entities (XXE)
	- [ ] Broken Access Control
	- [ ] Security Misconfiguration
	- [ ] Cross-Site Scripting (XXS)
	- [ ] Insecure Deserialization
	- [ ] Using Components with know Vulnerabilities
	- [ ] Insufficient Logging & Monitoring
- [ ] Attack Vectors
	- [ ] Mutillidae
	- [ ] DVWA
	- [ ] WebDAV
	- [ ] phpMyAdmin
	- [ ] Twiki
---------------------------

## Information Gathering

I ran the metasploit framework on docker using `sudo docker run --rm -it -p 80:8080 peakkk/metasploitable`

ip address > `172.17.0.2`

First off let's do an nmap scan 

![nmap](images/nmap_scan.png)

Finding the ports available and their uses, we can find the versions that are being used using the `-sV` nmap switch

![nmap version scan](images/nmap_version_scan.png)

### Web Server and technologies

The Following web technologies were discovered

![whatweb discovery](images/whatweb.png)

We find that the server is an _ubuntu linux_ server running _Apache v2.2.8_, title is _Metasploitable2 - Linux_

### Vulnerable versions

From the version scan run, we can identify the vulnerable versions that are being run by the service using `searchsploit`

1. Port 21 - ftp - vsftpd 2.3.4
![Port 21 searchsploit](images/port21.png)

2. Port 22 - ssh - OpenSSH 4.7p1 Debian 8ubuntu1
![Port 22 searchsploit](images/port22.png)

3. Port 23 - telnet - Linux telnetd
![port 23 searchsploit](images/port23.png)

4. Port 80 - http - Apache httpd 2.2.8 ((Ubuntu) DAV/2)

5. Port 139 & Port 445- netbios-ssn - Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
![Port 139 searchsploit](images/port139A.png)
![Port 139 searchsploit](images/port139B.png)

6. Port 514 - shell - Netapp ONTAP rshd

7. Port 1099 - java rmi - GNU Classpath grmiregistry
![Port 1099 searchsploit](images/port1099.png)

8. Port 2121 - ftp - ProFTPD 1.3.1
![Port 2121 searchsploit](images/port2121.png)

9. Port 3306 - mysql - MySQL 5.0.51a-3ubuntu5
![Port 3306 searchsploit](images/port3306.png)

10. Port 5900 - vnc - VNC (protocol 3.3)
![Port 5900 searchsploit](images/port5900.png)

11. Port 6667 && Port 6697- irc - UnrealIRCd (Admin email admin@Metasploitable.LAN)
![Port 6667 searchsploit](images/port6667.png)

12. Port 8180 - http - Apache Tomcat/Coyote JSP engine 1.1
![Port 8180 searchsploit](images/port8180.png)

13. Port 8787 - drb - Ruby DRb RMI (Ruby 1.8; path /usr/lib/ruby/1.8/drb)
![Port 8787 searchsploit](images/port8787.png)

---------------------------------------------------------

## Exploitation

After carrying out the nmap scan, finding open ports, identifying the different vulnerablities for the versions, next up is exploitation; finding out how secure the services running in the ports are.


### Port 21
First up is **port 21**, ftp.

We will be using metasploit

**Version Scan and exploitation**

Within metasplot framework, we can run an nmap service as well to check on the services running and versions in port 21
![](images/msf_nmap.png)

Within msf we can search for modules that we can use to exploit ftp
![](images/msf1.png)

We can use the auxiliary module for ftp is `auxiliary/scanner/ftp/ftp_version`

Set the RHOSTS and the LHOSTS then show options
![](images/msf2.png)

There is an ftp server present ie `vsftpd 2.3.4`. Use searchsploit to do a search in exploitDB to find exploits we can use;
![Port 21 searchsploit](images/port21.png)

From the above, there is a backdoor command execution exploit for the available version that's being used.
![](images/msf3.png)

Use the above exploit, confirm everything is okay then run the exploit
![](images/msf4.png)

We now have an active session running which can be sent to the background using `Ctr+z`
![](images/msf5.png)

use hashdump module to get users and their passwords, set the SESSION the same as the session running in the background then run
![](images/msf6.png)
![](images/msf7.png)

Use the `loot` command to see the results for the exploit just run.
![](images/msf8.png)

Use `John the Ripper` to crack the files and the --show command to view the results/
![](images/msf9.png)


**Anonymous Login**

Next up we can check if the ftp server allows for anonymous login using the auxiliary module anonymous through `use auxiliary/scanner/ftp/anonymous`.

![](images/msf10.png)

The FTP server has the permission **READ** for anonymous login.

Logging into the FTP using Filezilla anonymous user, we get a successful login.
![](images/msf11.png)

**Unencrypted Clear text login**

The host port runs an FTP service that allows cleartext logins over unencrypted connections.

One can uncover the login names and passwords by sniffing traffic to the FTP service using [Wireshark](https://www.wireshark.org/)

---------------------------------------------------------------------------------------

### Port 22

Port 22 runs on OpenSSH 4.7p1 Debian 8ubuntu1
![Port 22 searchsploit](images/port22.png)

Since port 22 is open we can use the auxiliary scanner `ssh_login` to bruteforce a password and see if we can login into it.

![](images/ssh1.png)
![](images/ssh2.png)

From the above we get a success of the username and password being msfadmin; msfadmin.

Login to the ssh using the above session through `sessions -i 1` and we have a successful login.
![](images/ssh3.png)

We can confirm the password by connecting via ssh as below.
![](images/ssh4.png)

---------------------------------------------------------------------------------------

### Port 23

Port 23 is telnet and runs on Linux telnetd

![port 23 searchsploit](images/port23.png)

Using an auxiliary module for telnet_login and userpass_file `/usr/share/metasploit-framework/data/wordlists/telnet_cdata_ftth_backdoor_userpass.txt`, we are able to get a login success using the username and password `msfadmin:msfadmin`
![](images/telnet1.png)

Using telnet to login we have a successful login into the metasploitable machine
![](images/telnet2.png)

---------------------------------------------------------------------------------------
### Port 25

Port 25 is responsible for SMTP and is an internet mailing system that operates at the **Application Layer** of the TCP/IP stack.

Use nmap scan in msf to identify the version running and services.
![](images/smtp1.png)
![](images/smtp2.png)

We can also confirm that port 25 is open using telnet
![](images/smtp6.png)

We can search for modules we can use using msf and we get an auxiliary module that we can use, ie, `auxiliary/scanner/smtp/smtp_version` , and can be used for SMTP banner grabbing.

Run the above module and then `services -p 25`

![](images/smtp3.png)

We can do user enumeration for SMTP using `auxiliary/scanner/smtp/smtp_enum`
![](images/smtp4.png)

This scan could take a while but produces a list of users available.
![](images/smtp5.png)

So the users found are :
```
backup, bin, daemon, distccd, ftp, games, gnats, irc, libuuid, list, lp, mail, man, mysql, news, nobody, postfix, postgres, postmaster, proxy, service, sshd, sync, sys, syslog, user, uucp, www-data
```

The above users can be verified by using the **VRFY** command after logging in using netcat [nc] .
![](images/smtp6)

Basic [smtp commands](https://www.ibm.com/docs/en/zos/2.3.0?topic=set-smtp-commands)


------------------------------------------------------------------

### Port 80

Port 80 is the default port used for http services ie web pages.

It is a stateless protocol that is based on request-response activity. 

![](images/http1.png)

Port 80 is runnning Apache in ubuntu. 

We can as well use a http_version scan by msf which is an auxiliary module

![](images/http2.png)
![](images/http3.png)

We can search for vulnerabilities related to the apacher version as below;
![](images/http5.png)

We can exploit using the php cgi exploit
![](images/http6.png)

After exploiting we get a meterpreter shell session.
![](images/http7.png)

---------------------------------------------------------------------------------------

### Port 139 & 445 

Port 139 & Port 445- netbios-ssn - Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
![Port 139 searchsploit](images/port139A.png)
![Port 139 searchsploit](images/port139B.png)

> SMB - Server Message Block

This is a protocol used in windows networks for sharing resources.

It runs n top of both NetBIOS on port 139 and Microsoft DS on port 445.

First off, we can check the version of SMB running using the auxiliary scanner for `smb_version`
![](images/smb1.png)

We can use searchsploit to get the exploits that can be used.
![](images/smb2.png)

The above can be gotten in msf
![](images/smb3.png)

We have a reverse TCP session
![](images/smb4.png)

-----------------------------------------------------------------------------------------


